/*! nekumo-web 2016-01-16 17:41 */
function ProgrammingError(a){this.message=a,this.name="ProgrammingError"}function absolute(a,b){if("/"==b)return"/";var c=a.split("/"),d=b.split("/");c.pop();for(var e=0;e<d.length;e++)"."!=d[e]&&(".."==d[e]?c.pop():c.push(d[e]));return c.join("/")}function humanize_count_nodes(a,b){a=Number.isInteger(a)?a:a.length,b=Number.isInteger(b)?b:b.length;var c="";return c+=a?sprintf("%d archivo%s",a,a>1?"s":""):"",c+=a&&b?" y ":"",c+=b?sprintf("%d carpeta%s",b,b>1?"s":""):""}var ICONS={"inode/directory":{icon:"folder",color:"#17b5f9"},text:{icon:"description",color:"#de3641"},video:{icon:"movie",color:"#004d40"},"audio/ogg":{icon:"file-formats-icons-ogg"},"image/jpeg":{icon:"file-formats-icons-jpg3"},"image/png":{icon:"file-formats-icons-png3"},"application/zip":{icon:"file-formats-icons-zip6"},"audio/mpeg":{icon:"file-formats-icons-mp36"},"application/x-javascript":{icon:"file-formats-icons-js2"},"text/x-python":{icon:"file-formats-icons-python3"},"application/pdf":{icon:"file-formats-icons-pdf19"},"application/x-rar-compressed":{icon:"file-formats-icons-rar2"},"application/x-bittorrent":{icon:"file-formats-icons-torrent"},"text/css":{icon:"file-formats-icons-css5"},"text/html":{icon:"file-formats-icons-html9"},"null":{icon:"help",style:"padding-left: 2px;"}};app.config(["NotificationProvider","$locationProvider",function(a,b){a.setOptions({delay:3e4,startTop:10,startRight:10,verticalSpacing:20,horizontalSpacing:20,positionX:"right",positionY:"bottom"}),b.html5Mode({enabled:!0,requireBase:!1})}]),app.config(["$mdThemingProvider",function(a){a.theme("default").primaryPalette("indigo").accentPalette("blue").warnPalette("red")}]),app.factory("Node",["WebSocket",function(a){var b=function(c,d){var e=this;e.selected=!1,e.__init__=function(){e.node=e.get_node()},$.each(c,function(a,b){e[a]=b}),e.get_relative_path=function(){return"dir"==e.type?e.name+"/":e.name},e.get_node=function(){var a=decodeURIComponent(e.node);return"/"!=a[0]&&(a="/"+a),a},e.get_subnode=function(a){var c=e.get_node();return _.endsWith(c,"/")||(c+="/"),c+=a,c=new b({node:c,name:a})},e.split=function(){var a=e.get_node().split("/"),c=a.pop(),d=new b({node:a.join("/"),name:a[a.length-1],type:"dir"});return[d,c]},e.copy=function(b,c,d,f){a.get({method:"copy",node:e.get_node(),dest:b.get_node(),override:!0}).then(c,d,f)},e.exists=function(b,c,d){a.get({method:"exists",node:e.get_node()}).then(b,c,d)},e.move=function(b,c,d,f){a.get({method:"move",node:e.get_node(),dest:b.get_node(),override:!0}).then(c,d,f)},e.count=function(b,c,d){if("dir"!=e.type)throw new ProgrammingError("Count solo se puede usar en directorios.");a.get({method:"count",node:e.get_node()}).then(b,c,d)},e.rm=function(b,c,d){a.get({method:"rm",node:e.get_node()}).then(b,c,d)},e.get_icon=function(){var a=e.mimetype,b=ICONS[a];return void 0==b&&(a=a.split("/")[0],b=ICONS[a]),void 0==b?ICONS[null]:b},e.select=function(){e.selected=!0,-1==d.selected.indexOf(e)&&d.selected.push(e)},e.unselect=function(){e.selected=!1,d.selected.indexOf(e)>-1&&d.selected.splice(d.selected.indexOf(e),1)},e.isSelected=function(){return e.selected},e.toggleSelect=function(){e.isSelected()?e.unselect():e.select()},e.__init__()};return b.prototype.constructor=Object,{create:function(a,c){return new b(a,c)}}}]),app.filter("decodeURIComponent",function(){return window.decodeURIComponent}),app.filter("bytes",function(){return function(a,b){if(isNaN(parseFloat(a))||!isFinite(a))return"-";if(0==a)return"0 bytes";"undefined"==typeof b&&(b=1);var c=["bytes","KiB","MiB","GiB","TiB","PiB"],d=Math.floor(Math.log(a)/Math.log(1024));return(a/Math.pow(1024,Math.floor(d))).toFixed(b)+" "+c[d]}}),app.animation(".ani-slide",[function(a){return{enter:function(a,b){jQuery(a).fadeIn(1e3,b)},move:function(a,b){jQuery(a).fadeIn(1e3,b)},leave:function(a,b){jQuery(a).addClass("alert"),setTimeout(function(){jQuery(a).fadeOut(1e3,b)},1500)}}}]),app.directive("nekumoNodeMenu",["$rootScope","$timeout",function(a,b){return{scope:{node:"="},templateUrl:"nekumo/menu-node.tmpl.html",link:function(c){c.open_menu=function(d,e){c.node&&!c.node.selected&&(c.node.select(),c.menu_right_node=c.node),d(e),a.$on("mdMenuHidden",function(){b(function(){null!=$scope.menu_right_node&&(console.debug("Deseleccionar "+$scope.menu_right_node),$scope.menu_right_node.unselect(),$scope.menu_right_node=null)},50)})},c.menuCtrl={paste:c.$parent.paste,copy:c.$parent.copy,cut:c.$parent.cut,rm:c.$parent.rm}}}}]),app.controller("Nodes",["$rootScope","$scope","$timeout","$location","$window","$mdDialog","$mdToast","$mdMenu","WebSocket","Node","DialogMessage",function(a,b,c,d,e,f,g,h,i,j,k){NodesScope=b,b.filter={},b.orderField="name",b.selected=[],b.cut_copy_nodes_exists=[],b.cut_copy_action="",b.cutCopyDefaultAction=null,b.name="",b.menu_right_node=null;var l=function(){var a=b.get_selected_nodes();b.cut_copy_nodes=[],angular.forEach(a,function(a){a.extra_style_class="cut_copy",a.unselect(),b.cut_copy_nodes.push(a)}),g.show(g.simple().action("Cancelar").highlightAction(!1).content("Tiene archivos en su portapapeles listos para pegar.").hideDelay(0)).then(function(a){"ok"==a&&(angular.forEach(b.cut_copy_nodes,function(a){a.extra_style_class=""}),b.cut_copy_nodes=[],b.cut_copy_action="",g.show(g.simple().content("Se ha cancelado el pegado de los archivos.")))})};b.getDirectory=function(a){a||(a=b.node),b.unselectAll(),b.nodes=null,$("#nodes").find("tr").removeClass("ani-slide");var d=c(function(){$("#loading").show()},20),e=c(function(){b.slow_load=!0},50);i.get({method:"ls",node:decodeURIComponent(a)}).then(function(a){b.nodes=_.map(a.nodes,function(a){return new j.create(a,b)}),b.name=a.name,c.cancel(e),c.cancel(d),$("#nodes").find("tr").addClass("ani-slide"),$("#loading").hide(),b.slow_load=!1},function(a){k.error("Error al listar el directorio",printf("Se ha producido un error al solicitar un directorio. El servidor devolvió: «%s»",a.message))})},b.get_breadcrumb_nodes=function(){var a=b.node.split("/");return a=a.slice(1,a.length-1)},b.get_selected_nodes=function(){return _.filter(b.nodes,function(a){return a.selected})},b.toggleSelected=function(){b.allSelected()?b.unselectAll():b.selectAll()},b.allSelected=function(){return b.selected.length>=(b.nodes||[]).length},b.selectAll=function(){angular.forEach(b.nodes,function(a){a.select()})},b.unselectAll=function(){angular.forEach(b.get_selected_nodes(),function(a){a.unselect()})},b.set_menu_right_node=function(a){b.menu_right_node=a},b.remove_node=function(a,c){void 0==c&&(c=b.nodes),_.remove(c,function(b){return a==b.get_node()})},b.go_to=function(a,e){a=absolute(getCurrentNode(),a),void 0!=e&&e.preventDefault(),d.path(a),c(function(){b.node=getCurrentNode(),b.breadcrumb_nodes=b.get_breadcrumb_nodes(),b.getDirectory()},50)},b.rm=function(a,c){var d=function(a,d,e,g){var h="Ha seleccionado ";h+=humanize_count_nodes(d,a)+".",(g||e)&&(h+=sprintf(" Además, por el borrado de %s, se perderá: ",a.length>1?"las carpetas":"la carpeta"),h+=humanize_count_nodes(g,e),h+=".");var i=f.confirm().title("Peligro de manazas: borrado de archivos.").content(h).ariaLabel("Lucky day").ok("Aceptar").cancel("Mejor no").targetEvent(c);f.show(i).then(function(){function c(a){var c=a.node;b.remove_node(c)}angular.forEach(d,function(a){a.rm(c)}),angular.forEach(a,function(a){a.rm(c)}),b.unselectAll()},function(){b.unselectAll()})},e=b.get_selected_nodes(),g=_.filter(e,function(a){return"dir"==a.type}),h=_.filter(e,function(a){return"dir"!=a.type}),i=0,j=0;if(g.length){var k=0,l=function(a){i+=a.dirs,j+=a.files,k+=1,g.length>k?g[k].count(l):d(g,h,i,j)};g[k].count(l)}else d(g,h,i,j)},b.cut=function(){b.cut_copy_action="cut",l()},b.copy=function(){b.cut_copy_action="copy",l()},b.paste=function(a){function c(){b.cut_copy_nodes.length||(b.cut_copy_action="",angular.forEach(b.nodes,function(a){a.extra_style_class=a.extra_style_class?a.extra_style_class.replace("cut_copy",""):""}),g.show(g.simple().content("Todos los archivos se han terminado de pegar.")))}function d(a,d,e){a[e](d,function(a){"cut"==b.cut_copy_action&&b.remove_node(a.node),b.remove_node(a.node,b.cut_copy_nodes),c()})}function e(a){b.remove_node(a.node,b.cut_copy_nodes),c()}function h(a,c,g){c.exists(function(i){return i.exists&&"override"!=b.cutCopyDefaultAction?"ignore"==b.cutCopyDefaultAction?e(a):(b.cut_copy_nodes_exists.length||f.show({scope:b,preserveScope:!0,templateUrl:"nekumo/copy_paste_nodes_exists.tmpl.html",parent:angular.element(document.body),clickOutsideToClose:!1,controller:["$scope","$mdDialog",function(a,b){a.hide=function(){b.hide()},a.cancel=function(){b.cancel()},a.rename=function(b,c){c=c.split()[0].get_subnode(c.name),h(b,c,g),a.clear(b)},a.ignore=function(b,c){e(b),a.clear(b)},a.override=function(b,c){d(b,c,g),a.clear(b)},a.clear=function(b){var c=_.filter(a.cut_copy_nodes_exists,{orig:b})[0];_.remove(a.cut_copy_nodes_exists,function(a){return a==c}),a.cut_copy_nodes_exists.length||a.hide()},a.overrideAll=function(){a.cutCopyDefaultAction="override",a.applyAll()},a.ignoreAll=function(){a.cutCopyDefaultAction="ignore",a.applyAll()},a.applyAll=function(){angular.forEach(a.cut_copy_nodes_exists,function(b){a[a.cutCopyDefaultAction](b.orig,b.dest_node)})}}]}),void b.cut_copy_nodes_exists.push({orig:a,dest_node:c})):d(a,c,g)})}g.hide(),a?(a.unselect(),a=a.get_node()):a=b.node;var i={copy:"copy",cut:"move"}[b.cut_copy_action];angular.forEach(b.cut_copy_nodes,function(b){var c=[a,b.name].join("/"),d=new j.create({node:c,name:b.name});h(b,d,i)})},b._=_,b.Math=Math,b.node=getCurrentNode(),b.breadcrumb_nodes=b.get_breadcrumb_nodes(),b.getDirectory()}]);